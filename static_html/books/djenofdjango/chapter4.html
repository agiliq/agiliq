
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 4. Building a Blog &mdash; Djen of Django</title>
    
    <link rel="stylesheet" href="_static/base.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/minify.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Djen of Django" href="index.html" />
    <link rel="next" title="Chapter 5. Building a Wiki" href="chapter5.html" />
    <link rel="prev" title="Chapter 3. Building a Pastebin." href="chapter3.html" /> 
  </head>
  <body>
    <div id="wrap">
        <div id="headerMeta"></div>
        <div id="header">
            <div class="container">
                <div class="sixteen columns">
                    <div class="logo">
                                <h1><a href="../../index.html"><img src="_static/logo.png" alt="Logo"/>
                                </a></h1>
                                <h2><div class="headertitle"><a href="index.html">Djen of Django</a></div></h2>
                    </div>
                </div>
            </div>
        </div>

        <div id="main_wrap">
            <div id="main">
                <div class="container">
            		<div class="twelve columns blog post main-content">
                        <div class="content no-img">
                            <div class="twelve columns omega">
                                    
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chapter-4-building-a-blog">
<h1>Chapter 4. Building a Blog<a class="headerlink" href="chapter4.html#chapter-4-building-a-blog" title="Permalink to this headline">¶</a></h1>
<div class="section" id="topics-in-this-chapter">
<h2>Topics in this chapter:<a class="headerlink" href="chapter4.html#topics-in-this-chapter" title="Permalink to this headline">¶</a></h2>
<p>So far, we have seen how to use django&#8217;s admin interface, and generic views. In this chapter we
will write custom views and blog entry admin page, store some user details in the session
and use date based generic views for our blog archives.</p>
<div class="section" id="models-with-foreignkeys">
<h3>Models with ForeignKeys:<a class="headerlink" href="chapter4.html#models-with-foreignkeys" title="Permalink to this headline">¶</a></h3>
<p>To link two Models, we use foreign keys. Since we may have many comments for a blog post, we would like
to have a relation from the comment model to the post model. This can be done by using a model field of
the type &#8216;ForeignKey&#8217;. It requires a string or class representing the Model to which the ForeignKey is to
be created. We would also need ForeignKey to link each blog post to it&#8217;s owner, since we want only the admin
to be able to create a post.</p>
<p>As we shall see, django simplifies access to foreign keys by automatically creating a related object set
on the linked Model.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="o">...</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>would relate each <tt class="docutils literal"><span class="pre">Post</span></tt> to multiple <tt class="docutils literal"><span class="pre">Comment</span></tt></p>
<p>Now, to fetch all comments related to a Post, we can use</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">comments</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">comment_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
<p>So, <tt class="docutils literal"><span class="pre">post</span></tt> gets a <tt class="docutils literal"><span class="pre">&lt;ForeignKeyModel&gt;_set</span></tt> property which is actually the <tt class="docutils literal"><span class="pre">Manager</span></tt> for <tt class="docutils literal"><span class="pre">Comments</span></tt>
related to that <tt class="docutils literal"><span class="pre">post</span></tt>.</p>
</div>
<div class="section" id="modelforms">
<h3>ModelForms:<a class="headerlink" href="chapter4.html#modelforms" title="Permalink to this headline">¶</a></h3>
<p>We have already seen how the <tt class="docutils literal"><span class="pre">admin</span></tt> app creates the form for our model by inspecting its fields. If we want to
customize the autogenerated forms, we can use ModelForms. In this chapter we see how to use ModelForms to create
and customize the forms for post and comment models. By convention, all custom forms should be in &lt;app&gt;/forms.py</p>
<p>The simplest way to use ModelForms would be:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PostForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>
</pre></div>
</div>
<p>The autogenerated fields can be overridden by explicitly specifying the field.
To change the html widget and label used by <tt class="docutils literal"><span class="pre">text</span></tt> field of <tt class="docutils literal"><span class="pre">Post</span></tt> model, one would do:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PostForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">TextArea</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Entry&#39;</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-views-with-forms-and-decorators">
<h3>Custom views with forms and decorators:<a class="headerlink" href="chapter4.html#custom-views-with-forms-and-decorators" title="Permalink to this headline">¶</a></h3>
<p>We will write our custom views in this chapter. We have already introduced views in the previous chapter, so we will
see how to use forms in our views and how to limit access to certain views using decorators.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">form</span> <span class="o">=</span> <span class="n">PostForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we are handling GET and POST in the same view. If this is a GET request, the form would be empty else it would be filled
with the POST contents.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">form</span><span class="o">.</span><span class="n">is_valid</span>
</pre></div>
</div>
<p>validates the form and returns <tt class="docutils literal"><span class="pre">True</span></tt> or <tt class="docutils literal"><span class="pre">False</span></tt></p>
<p>We will use these two together to save a valid form or display empty form.</p>
<p>To restrict views to a condition, we can use the <tt class="docutils literal"><span class="pre">user_passes_test</span></tt> decorator from <tt class="docutils literal"><span class="pre">contrib.auth</span></tt>.
The decorator takes a callable which should perform the test on the <tt class="docutils literal"><span class="pre">user</span></tt> argument and return <tt class="docutils literal"><span class="pre">True</span></tt> or <tt class="docutils literal"><span class="pre">False</span></tt>.
The view is called only when the user passes the test. If the user is not logged in or does not pass the test,
it redirects to <tt class="docutils literal"><span class="pre">LOGIN_URL</span></tt> of settings. By default this is <tt class="docutils literal"><span class="pre">/accounts/login</span></tt> and we will handle this url from urls.py</p>
<p>Some other useful decorators are:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">django.contrib.admin.views.decorators</span> <span class="pre">import</span> <span class="pre">staff_member_required</span></tt></p>
<p>Restricts view to staff members only.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">django.contrib.auth.decorators.login_required</span></tt></p>
<p>Restricts view to logged in users only</p>
</li>
</ul>
</div>
</div>
<div class="section" id="our-blog-app">
<h2>Our blog app:<a class="headerlink" href="chapter4.html#our-blog-app" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s list out the features we would want to see in our blog:</p>
<ul class="simple">
<li>Create/Edit blog post (restricted to admin)</li>
<li>View blog post (public)</li>
<li>Comment on a blog post (anonymous)</li>
<li>Store anonymous user details in session</li>
<li>Show month based blog archives</li>
<li>Generate RSS feeds</li>
</ul>
<p>We have two models here: <tt class="docutils literal"><span class="pre">Post</span></tt> and <tt class="docutils literal"><span class="pre">Comment</span></tt>. The data we would like store are:</p>
<p>For Post:</p>
<ul class="simple">
<li>Title</li>
<li>Text Content</li>
<li>Slug</li>
<li>Created Date</li>
<li>Author</li>
</ul>
<p>For Comment:</p>
<ul class="simple">
<li>Name</li>
<li>Website</li>
<li>Email</li>
<li>Text Content</li>
<li>Post related to this comment</li>
<li>Created Date</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since we want anonymous to be able to comment on a post, we are not relating the comment poster
to a registered user.</p>
</div>
<p>We want the <tt class="docutils literal"><span class="pre">author</span></tt> field of the post to be mapped to a registered user and the <tt class="docutils literal"><span class="pre">post</span></tt> field
to be mapped to a valid <tt class="docutils literal"><span class="pre">Post</span></tt>. As we shall see, we will ForeignKeys to the appropriate models
to manage these.</p>
<div class="section" id="models">
<h3>Models:<a class="headerlink" href="chapter4.html#models" title="Permalink to this headline">¶</a></h3>
<p>We have already seen how to create and integrate an app into our project, so I will start with the models</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.template.defaultfilters</span> <span class="kn">import</span> <span class="n">slugify</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="c"># Create your models here.</span>

<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">slug</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlugField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>

    <span class="nd">@models.permalink</span>
    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;blog_post_detail&#39;</span><span class="p">,</span> <span class="p">(),</span> 
                <span class="p">{</span>
                    <span class="s">&#39;slug&#39;</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span>
                <span class="p">})</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">slug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slug</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
    <span class="n">website</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span>
</pre></div>
</div>
<p>Quite a few new things here, let&#8217;s analyze them:</p>
<ul class="simple">
<li>slug field - it is used for storing slugs (e.g. this-is-a-slug). SEO or something.</li>
<li>We will be using slugs in the url to fetch a blog post, so this must be unique.</li>
<li><tt class="docutils literal"><span class="pre">slugify</span></tt> is a helper function to get slug from a string. We won&#8217;t need to get the slug from the form,
we will generate it ourself using <tt class="docutils literal"><span class="pre">slugify</span></tt></li>
<li>To autogenerate the slug, we override the <tt class="docutils literal"><span class="pre">model</span></tt> save method, whose signature is <tt class="docutils literal"><span class="pre">save(self,</span> <span class="pre">*args,</span> <span class="pre">**kwargs)</span></tt>
We set <tt class="docutils literal"><span class="pre">self.slug</span></tt> to the slug generated by <tt class="docutils literal"><span class="pre">slugify</span></tt> and call the parent <tt class="docutils literal"><span class="pre">save</span></tt> method.</li>
<li>This ensures that every time a model is saved, it will have a slug field.</li>
<li>The <tt class="docutils literal"><span class="pre">get_absolute_url</span></tt> of the <tt class="docutils literal"><span class="pre">Post</span></tt> model points to the <tt class="docutils literal"><span class="pre">blog_post_detail</span></tt> which takes a <tt class="docutils literal"><span class="pre">slug</span></tt> parameter.
This is the <tt class="docutils literal"><span class="pre">Post</span></tt> detail view, and it fetches the post based on the <tt class="docutils literal"><span class="pre">slug</span></tt>. We will soon see how this is implemented.</li>
<li><tt class="docutils literal"><span class="pre">model.ForeignKey</span></tt> is a ForeignKey field which can be used to link this model to any other model. Here we want to link the <tt class="docutils literal"><span class="pre">author</span></tt>
field to a <tt class="docutils literal"><span class="pre">User</span></tt>, which is django&#8217;s model for a user. It comes from <tt class="docutils literal"><span class="pre">django.contrib.auth</span></tt> app, which is another useful package
shipped with django.</li>
<li>Similarly to link a <tt class="docutils literal"><span class="pre">Comment</span></tt> to a <tt class="docutils literal"><span class="pre">Post</span></tt> we have a ForeignKey from in the <tt class="docutils literal"><span class="pre">post</span></tt> field of the comment.</li>
<li>We won&#8217;t need the <tt class="docutils literal"><span class="pre">author</span></tt> field from the <tt class="docutils literal"><span class="pre">Post</span></tt> form either, but we will fill it up in the view, where we have access to the
logged in user details</li>
</ul>
</div>
<div class="section" id="views">
<h3>Views:<a class="headerlink" href="chapter4.html#views" title="Permalink to this headline">¶</a></h3>
<p>The views we would need are:</p>
<ul class="simple">
<li>Admin should be able to login</li>
<li>Add/Edit a post - restricted to admin</li>
<li>View a blog post</li>
<li>Comment on a blog post</li>
</ul>
<p>We need to customize our forms to only display fields which need user input, because we will take care of the rest. For example, we have already
seen how to autofill slug field. Next, we would like to autofill <tt class="docutils literal"><span class="pre">post</span></tt> for <tt class="docutils literal"><span class="pre">Comment</span></tt> and <tt class="docutils literal"><span class="pre">author</span></tt> for <tt class="docutils literal"><span class="pre">Post</span></tt> in the view. Heres our
<tt class="docutils literal"><span class="pre">blog/forms.py</span></tt></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Post</span><span class="p">,</span> <span class="n">Comment</span>

<span class="k">class</span> <span class="nc">PostForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">,</span> <span class="s">&#39;slug&#39;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">CommentForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Comment</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;post&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>For login, we will use <tt class="docutils literal"><span class="pre">django.contrib.auth.views.login</span></tt> view which is included in the <tt class="docutils literal"><span class="pre">contrib.auth</span></tt> app. It expects a <tt class="docutils literal"><span class="pre">registration/login.html</span></tt>
which we will steal from <tt class="docutils literal"><span class="pre">django/contrib/admin/templates/admin/login.html</span></tt>. We will include the login url in the project urls.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls.defaults</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># Uncomment the next two lines to enable the admin:</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="n">admin</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="c"># Example:</span>
    <span class="c"># (r&#39;^djen_project/&#39;, include(&#39;djen_project.foo.urls&#39;)),</span>

    <span class="c"># Uncomment the admin/doc line below and add &#39;django.contrib.admindocs&#39; </span>
    <span class="c"># to INSTALLED_APPS to enable admin documentation:</span>
    <span class="c"># (r&#39;^admin/doc/&#39;, include(&#39;django.contrib.admindocs.urls&#39;)),</span>

    <span class="c"># Uncomment the next line to enable the admin:</span>
    <span class="p">(</span><span class="s">r&#39;^accounts/login/$&#39;</span><span class="p">,</span> <span class="s">&#39;django.contrib.auth.views.login&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">r&#39;^pastebin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;pastebin.urls&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">r&#39;^blog/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;blog.urls&#39;</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In <tt class="docutils literal"><span class="pre">blog/templates/registration/login.html</span></tt>, copy contents from <tt class="docutils literal"><span class="pre">django/contrib/admin/templates/admin/login.html</span></tt></p>
<div class="highlight-django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;admin/base_site.html&quot;</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">i18n</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">extrastyle</span> <span class="cp">%}{%</span> <span class="k">load</span> <span class="nv">adminmedia</span> <span class="cp">%}{{</span> <span class="nb">block</span><span class="nv">.super</span> <span class="cp">}}</span><span class="x">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;</span><span class="cp">{%</span> <span class="k">admin_media_prefix</span> <span class="cp">%}</span><span class="x">css/login.css&quot; /&gt;</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">bodyclass</span> <span class="cp">%}</span><span class="x">login</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content_title</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">breadcrumbs</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">error_message</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;p class=&quot;errornote&quot;&gt;</span><span class="cp">{{</span> <span class="nv">error_message</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;div id=&quot;content-main&quot;&gt;</span>
<span class="x">&lt;form action=&quot;</span><span class="cp">{{</span> <span class="nv">app_path</span> <span class="cp">}}</span><span class="x">&quot; method=&quot;post&quot; id=&quot;login-form&quot;&gt;</span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  &lt;div class=&quot;form-row&quot;&gt;</span>
<span class="x">    &lt;label for=&quot;id_username&quot;&gt;</span><span class="cp">{%</span> <span class="k">trans</span> <span class="s1">&#39;Username:&#39;</span> <span class="cp">%}</span><span class="x">&lt;/label&gt; &lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;id_username&quot; /&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">  &lt;div class=&quot;form-row&quot;&gt;</span>
<span class="x">    &lt;label for=&quot;id_password&quot;&gt;</span><span class="cp">{%</span> <span class="k">trans</span> <span class="s1">&#39;Password:&#39;</span> <span class="cp">%}</span><span class="x">&lt;/label&gt; &lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;id_password&quot; /&gt;</span>
<span class="x">    &lt;input type=&quot;hidden&quot; name=&quot;this_is_the_login_form&quot; value=&quot;1&quot; /&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">  &lt;div class=&quot;submit-row&quot;&gt;</span>
<span class="x">    &lt;label&gt;&amp;nbsp;&lt;/label&gt;&lt;input type=&quot;submit&quot; value=&quot;</span><span class="cp">{%</span> <span class="k">trans</span> <span class="s1">&#39;Log in&#39;</span> <span class="cp">%}</span><span class="x">&quot; /&gt;</span>
<span class="x">  &lt;/div&gt;</span>
<span class="x">&lt;/form&gt;</span>

<span class="x">&lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="x">document.getElementById(&#39;id_username&#39;).focus()</span>
<span class="x">&lt;/script&gt;</span>
<span class="x">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>For the others, we will write custom views in <tt class="docutils literal"><span class="pre">blog/views.py</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Create your views here.</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">user_passes_test</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render_to_response</span><span class="p">,</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>

<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">PostForm</span><span class="p">,</span> <span class="n">CommentForm</span>

<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_post</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">PostForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">post</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;blog/add_post.html&#39;</span><span class="p">,</span> 
                              <span class="p">{</span> <span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span> <span class="p">},</span>
                              <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">view_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">post</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;blog/blog_post.html&#39;</span><span class="p">,</span>
                              <span class="p">{</span>
                                  <span class="s">&#39;post&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">,</span>
                                  <span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
                              <span class="p">},</span>
                              <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p>Note:</p>
<ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">user_passes_test</span></tt> decorator whether the user is admin or not. If not, it will redirect the user to login page.</li>
<li>We are using the <tt class="docutils literal"><span class="pre">ModelForms</span></tt> defined in <tt class="docutils literal"><span class="pre">forms.py</span></tt> to autogenerate forms from our Models.</li>
<li><tt class="docutils literal"><span class="pre">ModelForm</span></tt> includes a <tt class="docutils literal"><span class="pre">save</span></tt> method (just like a <tt class="docutils literal"><span class="pre">Models</span></tt> save method) which saves the model data to the database.</li>
<li><tt class="docutils literal"><span class="pre">commit=False</span></tt> on a form save gives us the temporary <tt class="docutils literal"><span class="pre">Model</span></tt> object so that we can modify it and save permanently.
Here, we have used it to autofill the <tt class="docutils literal"><span class="pre">author</span></tt> of <tt class="docutils literal"><span class="pre">Post</span></tt> and <tt class="docutils literal"><span class="pre">post</span></tt> of <tt class="docutils literal"><span class="pre">Comment</span></tt></li>
<li><tt class="docutils literal"><span class="pre">redirect</span></tt> is a shortcut that redirects using <tt class="docutils literal"><span class="pre">HttpResponseRedirect</span></tt> to another url or a model&#8217;s <tt class="docutils literal"><span class="pre">get_absolute_url</span></tt> property.</li>
</ul>
</div>
<div class="section" id="templates">
<h3>Templates:<a class="headerlink" href="chapter4.html#templates" title="Permalink to this headline">¶</a></h3>
<p>The corresponding templates for these views would look like:</p>
<p><tt class="docutils literal"><span class="pre">blog/templates/blog/add_post.html</span></tt>:</p>
<div class="highlight-django"><div class="highlight"><pre><span class="x">&lt;h2&gt;Hello </span><span class="cp">{{</span> <span class="nv">user.username</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span>
<span class="x">&lt;br /&gt;</span>
<span class="x">&lt;h2&gt;Add new post&lt;/h2&gt;</span>
<span class="x">&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;table&gt;</span>
<span class="x">        </span><span class="cp">{{</span> <span class="nv">form.as_table</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">    &lt;/table&gt;</span>
<span class="x">    &lt;input type=&quot;submit&quot; name=&quot;add&quot; value=&quot;Add&quot; /&gt;</span>
<span class="x">&lt;/form&gt;</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">blog/templates/blog/blog_post.html</span></tt>:</p>
<div class="highlight-django"><div class="highlight"><pre><span class="x">&lt;h2&gt;</span><span class="cp">{{</span> <span class="nv">post.title</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span>

<span class="x">&lt;div class=&quot;content&quot;&gt;</span>
<span class="x">    &lt;p&gt;</span>
<span class="x">        </span><span class="cp">{{</span> <span class="nv">post.text</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">    &lt;/p&gt;</span>
<span class="x">    &lt;span&gt;</span>
<span class="x">        Written by </span><span class="cp">{{</span> <span class="nv">post.author</span> <span class="cp">}}</span><span class="x">  on </span><span class="cp">{{</span> <span class="nv">post.created_on</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">    &lt;/span&gt;</span>
<span class="x">&lt;/div&gt;</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="nv">post.comment_set.all</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;h2&gt;Comments&lt;/h2&gt;</span>
<span class="x">&lt;div class=&quot;comments&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">comment</span> <span class="k">in</span> <span class="nv">post.comment_set.all</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        &lt;span&gt;</span>
<span class="x">            &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">comment.website</span> <span class="cp">}}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">comment.name</span> <span class="cp">}}</span><span class="x">&lt;/a&gt; said on </span><span class="cp">{{</span> <span class="nv">comment.created_on</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">        &lt;/span&gt;</span>
<span class="x">        &lt;p&gt;</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">comment.text</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">        &lt;/p&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;br /&gt;</span>

<span class="x">&lt;h2&gt;Add Comment&lt;/h2&gt;</span>

<span class="x">&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;table&gt;</span>
<span class="x">        </span><span class="cp">{{</span> <span class="nv">form.as_table</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">    &lt;/table&gt;</span>
<span class="x">    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Submit&quot; /&gt;</span>
<span class="x">&lt;/form&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since <tt class="docutils literal"><span class="pre">Comment</span></tt> has a ForeignKey to <tt class="docutils literal"><span class="pre">Post</span></tt>, each <tt class="docutils literal"><span class="pre">Post</span></tt> object automatically gets a
<tt class="docutils literal"><span class="pre">comment_set</span></tt> property which provides an interface to that particular <tt class="docutils literal"><span class="pre">Post</span></tt>&#8216;s comments.</p>
</div>
</div>
<div class="section" id="sessions">
<h3>Sessions:<a class="headerlink" href="chapter4.html#sessions" title="Permalink to this headline">¶</a></h3>
<p>So far we have most of the blog actions covered. Next, let&#8217;s look into sessions:</p>
<p>Suppose we want to store the commenter&#8217;s details in the session so that he/she does not have to fill them again.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Create your views here.</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">user_passes_test</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render_to_response</span><span class="p">,</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>

<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">PostForm</span><span class="p">,</span> <span class="n">CommentForm</span>

<span class="nd">@user_passes_test</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_post</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">PostForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">post</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;blog/add_post.html&#39;</span><span class="p">,</span> 
                              <span class="p">{</span> <span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span> <span class="p">},</span>
                              <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">view_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">post</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">name</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&quot;email&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">email</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&quot;website&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">website</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="n">form</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
    <span class="n">form</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">)</span>
    <span class="n">form</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s">&#39;website&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;website&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;blog/blog_post.html&#39;</span><span class="p">,</span>
                              <span class="p">{</span>
                                  <span class="s">&#39;post&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">,</span>
                                  <span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
                              <span class="p">},</span>
                              <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p>Note that the <tt class="docutils literal"><span class="pre">form.initial</span></tt> attribute is a <tt class="docutils literal"><span class="pre">dict</span></tt> that holds initial data of the form. A session lasts until the user logs out or
clears the cookies (e.g. by closing the browser). django identifies the session using <tt class="docutils literal"><span class="pre">sessionid</span></tt> cookie.</p>
<p>The default session backend is <tt class="docutils literal"><span class="pre">django.contrib.sessions.backends.db</span></tt> i.e. database backend, but it can be configured to <tt class="docutils literal"><span class="pre">file</span></tt> or <tt class="docutils literal"><span class="pre">cache</span></tt> backend as well.</p>
</div>
</div>
<div class="section" id="date-based-generic-views">
<h2>Date based generic views:<a class="headerlink" href="chapter4.html#date-based-generic-views" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">reference: <a class="reference external" href="http://docs.djangoproject.com/en/1.2/ref/generic-views/#date-based-generic-views">http://docs.djangoproject.com/en/1.2/ref/generic-views/#date-based-generic-views</a></p>
</div>
<p>We will use date based generic views to get weekly/monthly archives for our blog posts:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls.defaults</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Post</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^post/(?P&lt;slug&gt;[-\w]+)$&#39;</span><span class="p">,</span> 
        <span class="s">&#39;blog.views.view_post&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&#39;blog_post_detail&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^add/post$&#39;</span><span class="p">,</span> 
        <span class="s">&#39;blog.views.add_post&#39;</span><span class="p">,</span> 
        <span class="n">name</span><span class="o">=</span><span class="s">&#39;blog_add_post&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^archive/month/(?P&lt;year&gt;\d+)/(?P&lt;month&gt;\w+)$&#39;</span><span class="p">,</span>
        <span class="s">&#39;django.views.generic.date_based.archive_month&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s">&#39;queryset&#39;</span><span class="p">:</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> 
            <span class="s">&#39;date_field&#39;</span><span class="p">:</span> <span class="s">&#39;created_on&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&#39;blog_archive_month&#39;</span><span class="p">,</span>
       <span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^archive/week/(?P&lt;year&gt;\d+)/(?P&lt;week&gt;\d+)$&#39;</span><span class="p">,</span>
        <span class="s">&#39;django.views.generic.date_based.archive_week&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s">&#39;queryset&#39;</span><span class="p">:</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> 
            <span class="s">&#39;date_field&#39;</span><span class="p">:</span> <span class="s">&#39;created_on&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&#39;blog_archive_week&#39;</span><span class="p">,</span>
       <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">archive_month</span></tt> generic views outputs to <tt class="docutils literal"><span class="pre">post_archive_month.html</span></tt> and <tt class="docutils literal"><span class="pre">archive_week</span></tt> to <tt class="docutils literal"><span class="pre">post_archive_week.html</span></tt></p>
<div class="highlight-django"><div class="highlight"><pre><span class="x">&lt;h2&gt;Post archives for </span><span class="cp">{{</span> <span class="nv">month</span><span class="o">|</span><span class="nf">date</span><span class="s2">:&quot;F&quot;</span> <span class="cp">}}</span><span class="x">, </span><span class="cp">{{</span> <span class="nv">month</span><span class="o">|</span><span class="nf">date</span><span class="s2">:&quot;Y&quot;</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span>

<span class="x">&lt;ul&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">object_list</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        &lt;li&gt;</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="nv">blog_post_detail</span> <span class="nv">post.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">post.title</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">        &lt;/li&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;/ul&gt;</span>
</pre></div>
</div>
<div class="highlight-django"><div class="highlight"><pre><span class="x">&lt;h2&gt;Post archives for week </span><span class="cp">{{</span> <span class="nv">week</span><span class="o">|</span><span class="nf">date</span><span class="s2">:&quot;W&quot;</span> <span class="cp">}}</span><span class="x">, </span><span class="cp">{{</span> <span class="nv">week</span><span class="o">|</span><span class="nf">date</span><span class="s2">:&quot;Y&quot;</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;</span>

<span class="x">&lt;ul&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">post</span> <span class="k">in</span> <span class="nv">object_list</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        &lt;li&gt;</span>
<span class="x">        &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="nv">blog_post_detail</span> <span class="nv">post.slug</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">post.title</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">        &lt;/li&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;/ul&gt;</span>
</pre></div>
</div>
<p>Now, blog archives should be accessible from <tt class="docutils literal"><span class="pre">/blog/archive/month/2010/oct</span></tt> or <tt class="docutils literal"><span class="pre">/blog/archive/week/2010/41</span></tt></p>
</div>
</div>


          </div>
        </div>
      </div>
                            </div>
                        </div>
                    </div>
                    <div class="four columns sidebar">
                        <div class="gce-widget">
                                <form method="get" action="search.html">
                                    <fieldset>
                                        <input id="q" class="search_input" type="text" name="q" value="search site" onclick="this.value='';" onfocus="javascript: if (formfield.defaultValue==formfield.value)formfield.value = ''" onblur="this.value=!this.value?'search site':this.value;" />
                                        <input class="submit" type="submit" value="Search" />
                                    </fieldset>
                                </form>
                        </div>
                        <div class="pages-widget">
                                <h3><a href="index.html">Table Of Contents</a></h3>
                                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter1.html">Chapter 1: Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter2.html">Chapter 2. Building a personal CD library.</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter3.html">Chapter 3. Building a Pastebin.</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="chapter4.html">Chapter 4. Building a Blog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="chapter4.html#topics-in-this-chapter">Topics in this chapter:</a></li>
<li class="toctree-l2"><a class="reference internal" href="chapter4.html#our-blog-app">Our blog app:</a></li>
<li class="toctree-l2"><a class="reference internal" href="chapter4.html#date-based-generic-views">Date based generic views:</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter5.html">Chapter 5. Building a Wiki</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter6.html">Chapter 6. Building a Yahoo Answer&#8217;s like site</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter7.html">Chapter 7. Building a Project management application</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter8.html">Chapter 8. Building a Social news Site</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="appendix1.html">Using Django with Appengine</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix2.html">Django for the PHP programmer</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix3.html">Django for the JSP/Sevelet programmer.</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix4.html">Hacking Django internals.</a></li>
</ul>

                                    <h3 style="margin-top: 1.5em;">This Page</h3>
                                        <a href="_sources/chapter4.txt" rel="nofollow">Show Source</a>
                        </div>
                    </div>
                    <div class="sixteen columns">
                        <div class="right">
                                    <a href="chapter3.html" title="Chapter 3. Building a Pastebin." accesskey="P">previous</a> |
                                    <a href="chapter5.html" title="Chapter 5. Building a Wiki" accesskey="N">next</a> |
                                    <a href="genindex.html" title="General Index" accesskey="I">index</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer">
            <div class="container">
                <div class="four columns">
                    <div class="contact-widget">
                        <h4>Contact Us</h4>
                        <ul>
                            <li><span>Email :</span> <a href="mailto:hello@agiliq.com" class="test">hello@agiliq.com</a></li>
                            <li><span>Address :</span><p> Agiliq Info Solutions India Pvt Ltd,<br/>
                            # 302, Siri Sampada Appts,<br/>
                            Near Madhapur Police Station,<br/>
                            Hyderabad - 500033. India.</p>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="four columns">
                    <div class="know-widget">
                        <h4>Know More</h4>
                        <ul>
                            <li> <a class="twitter" rel="nofollow" href="http://twitter.com/agiliqdotcom">Follow us on Twitter</a></li>
                            <li> <a class="facebook" rel="nofollow"  href="http://facebook.com/agiliq">Connect us on Facebook</a></li>
                            <li> <a class="linkedin" rel="nofollow" href="http://www.linkedin.com/company/agiliq-info-solutions-india-pvt-ltd">Linkedin</a></li>
                            <li><a class="youtube" rel="nofollow" href="http://www.youtube.com/user/agiliq">Youtube - Python Screencasts</a></li>
                            <li> <a class="posterous" rel="nofollow" href="http://people.agiliq.com/">Our Posterous</a></li>
                            <li> <a class="tumblr" rel="nofollow" href="http://agiliq.tumblr.com/">Our Tumblr</a></li>
                            <li> <a class="code" rel="nofollow" href="https://github.com/agiliq/">Code</a></li>
                        </ul>
                    </div>
                </div>
                <div class="four columns">
                    <div class="books-widget">
                        <h4>Read</h4>
                        <ul>
                            <li>
                                <a href="../../blog.1">Blog</a>
                            </li>
                            <li>
                                <a href="../../newsletter.1">Newsletter</a>
                            </li>
                            <li> <a href="../djangodesignpatterns/index.html">Django Design Patterns</a></li>
                            <li> <a href="index.html">Djen of Django</a></li>
                            <li> <a href="../djangogotchas/index.html">Django Gotchas</a></li>
                            <li> <a href="../../softwareconsulting.1">Software Consulting Howto</a></li>

                        </ul>
                    </div>
                </div>
               <div class="four columns">
                   <div class="links-widget">
                       <h4>About</h4>
                       <ul>
                           <li> <a href="../../index.html">Home</a></li>
                           <li> <a href="../../contact/index.html">Contact Us</a></li>
                           <li> <a href="../../whoweare">Who we are</a></li>
                           <li> <a href="../../whatwedo">What we do</a></li>

                           <li> <a href="../../blog.1">Blog</a></li>
                           <li> <a href="../../forum/index.html">Forum</a></li>

                       </ul>
                   </div>
               </div>
               <div class="copyright">
                        
    <div class="footer">
        &copy; Copyright 2010, Agiliq.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
               </div>
            </div>
        </div>
    </div>
    <!-- extra footer -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-367368-15']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>